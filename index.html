<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>San Andreas State Police - Organigramme Criminel</title>
  <style>
    /* Variables et reset */
    :root {
      --primary: #1a1a1a;
      --secondary: #2b6cb0;
      --accent: #5dade2;
      --light: #0a0a1f;
      --danger: #e74c3c;
      --success: #2ecc71;
      --text: #ffffff;
      --border: #2b6cb0;
      --canvas-bg: #0a0a1f;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.6);
      --transition: all 0.3s ease;
    }
    
    * { box-sizing:border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    html, body { height:100%; overflow:hidden; color: var(--text); background: var(--light); }

    /* Nouveau style de connexion */
    #login-screen {
      background: #0a0a1f;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      color: #fff;
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    .login-container {
      display: flex;
      width: 95%;
      max-width: 1200px;
      height: 600px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }
    
    .left-panel {
      flex: 1;
      background: url('https://cdn.discordapp.com/attachments/1357616051671662722/1412465847884054628/Copilot_20250902_174650.png?ex=68b864d4&is=68b71354&hm=45227093e196293237d5682d1372fb829f7f3f78462dcc40c86d718875005d39')
                  center center / cover no-repeat;
    }
    
    .right-panel {
      flex: 1;
      background: #1a1a1a;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .login-box {
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h3 {
      font-size: 2rem;
      margin-bottom: 30px;
      color: #5dade2;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .input-group {
      width: 100%;
      margin-bottom: 25px;
      text-align: left;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 10px;
      color: #5dade2;
      font-weight: 500;
    }
    
    .input-group input {
      width: 100%;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid #2b6cb0;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .input-group input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 10px rgba(91, 155, 213, 0.5);
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(90deg, #1f4d7a 0%, #2b6cb0 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    
    .login-btn:hover {
      background: linear-gradient(90deg, #2b6cb0 0%, #5dade2 100%);
      transform: translateY(-2px);
    }
    
    .login-btn:active {
      transform: translateY(0);
    }
    
    #login-error {
      margin-top: 20px;
      display: none;
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      padding: 10px;
      border-radius: 5px;
    }
    
    .security-tag {
      margin-top: 30px;
      color: #5dade2;
      font-size: 0.9rem;
    }
    
    @media (max-width: 900px) {
      .login-container {
        flex-direction: column;
        height: auto;
      }
      .left-panel, .right-panel {
        padding: 30px;
      }
    }

    /* App layout */
    #app {
      display:flex; 
      width:100%; 
      height:100%;
      background: var(--light);
    }
    
    /* Sidebar */
    #sidebar {
      width:280px; 
      border-right:1px solid var(--border);
      background:var(--primary); 
      display:flex; 
      flex-direction:column;
      box-shadow: var(--shadow);
      z-index: 10;
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .sidebar-header h2 {
      font-size: 1.25rem;
      color: var(--accent);
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    #table-list {
      margin-top: 1rem;
    }
    
    /* Style pour le bouton Nouveau tableau */
    #new-table {
      background: var(--secondary); 
      color: white; 
      border: none; 
      padding: 0.75rem; 
      border-radius: 4px; 
      cursor: pointer; 
      width: 100%; 
      margin-bottom: 15px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    #new-table:hover {
      background: var(--accent);
    }
    
    .table-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text);
    }
    
    .table-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .table-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      color: inherit;
      opacity: 0.7;
      height: 36px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    
    .icon-btn:hover {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Canvas container */
    #canvas-container {
      position:relative;
      flex:1; 
      overflow:hidden;
      background: var(--canvas-bg);
      cursor: grab;
    }
    
    #canvas-container.panning {
      cursor: grabbing;
    }
    
    /* Canvas wrapper for centering - R√âDUIT */
    #canvas-wrapper {
      position: relative;
      width: 4500px;  /* R√©duit de 5000px √† 6000px */
      height: 2500px; /* R√©duit de 3000px √† 5000px */
      margin: auto;
    }
    
    /* Canvas */
    #canvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      transform-origin: center;
      width: 4000px;
      height: 2000px;
      background: var(--primary);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease-out;
    }
    
    /* SVG for links */
    svg#link-svg {
      position:absolute; 
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      transform-origin: center;
      width:4000px;
      height:2000px;
      pointer-events:none;
      z-index: 2;
      transition: transform 0.2s ease-out;
    }
    
    /* Controls overlay - Centered at top */
    #controls-overlay {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display:flex; 
      gap:10px;
      background: var(--primary);
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    #controls-overlay button {
      background: var(--secondary);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      height: 36px;
      display: flex;
      align-items: center;
    }
    
    #controls-overlay button:hover {
      background: var(--accent);
    }
    
    /* Toolbar - Fixed position */
    #toolbar {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      gap: 10px;
      background: var(--primary);
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    .export-option {
      padding: 0.5rem 1rem;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      height: 36px;
      display: flex;
      align-items: center;
    }
    
    .export-option:hover {
      background: var(--accent);
    }
    
    /* Node styling - OPTIMIS√â */
    .node {
      position:absolute;
      min-width:140px;
      max-width:160px;
      background:var(--primary);
      border: 2px solid var(--accent);
      border-radius:8px;
      box-shadow: var(--shadow);
      padding:12px;
      cursor:grab;
      user-select:none;
      font-size:13px;
      transition: var(--transition);
      z-index: 10;
      color: var(--text);
      will-change: transform; /* Optimisation pour le GPU */
      transform: translate3d(0, 0, 0); /* D√©clenche l'acc√©l√©ration GPU */
    }
    
    .node:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }
    
    .node.dragging {
      cursor: grabbing;
      z-index: 100;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      transform: scale(1.02);
    }
    
    .node img {
      display:block; 
      width:100%; 
      height:120px;
      object-fit: cover;
      margin-bottom:8px; 
      border-radius:4px;
      cursor: pointer;
    }
    
    .node strong {
      display: block;
      margin-bottom: 4px;
      color: var(--accent);
    }
    
    .node small {
      color: #bdc3c7;
    }
    
    /* Styles am√©lior√©s pour les groupes import√©s */
    .imported-group {
      position: absolute;
      border: 2px dashed var(--border);
      background: rgba(43, 108, 176, 0.1);
      border-radius: 8px;
      z-index: 5;
      box-sizing: border-box;
    }
    
    .imported-group .group-header {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      height: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 5px;
      font-size: 12px;
      color: var(--accent);
    }
    
    .imported-group .group-controls {
      position: absolute;
      bottom: 5px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
    }
    
    .group-btn {
      width: 24px;
      height: 24px;
      border-radius: 3px;
      background: var(--primary);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .group-btn:hover {
      background: var(--secondary);
    }
    
    .group-handle {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      cursor: move;
      color: var(--accent);
      font-size: 16px;
    }
    
    /* Form popup - MODIFI√â POUR LES COULEURS */
    #form-popup {
      position:fixed; 
      top:50%; 
      left:50%; 
      transform:translate(-50%,-50%);
      background:var(--primary); 
      padding:24px; 
      border-radius:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display:none; 
      width:320px; 
      z-index:1000;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    #form-popup h3 { 
      margin-bottom:16px; 
      color:var(--accent); 
      font-size:18px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    #form-popup label { 
      display:block; 
      margin:8px 0 4px; 
      color:var(--accent); 
      font-size:14px;
      font-weight: 500;
    }
    
    #form-popup input,
    #form-popup select,
    #form-popup textarea {
      width:100%; 
      padding:8px; 
      background: #ffffff; /* Chang√© √† blanc */
      border:1px solid var(--border); 
      border-radius:4px;
      font-size:14px;
      color: #000000; /* Chang√© √† noir */
    }
    
    #form-popup textarea { 
      resize:vertical; 
      height:80px;
      font-family: inherit;
    }
    
    #form-popup .color-palette {
      display:grid; 
      grid-template-columns: repeat(5, 1fr); 
      gap:8px;
      margin:8px 0;
    }
    
    #form-popup .color-palette .color-swatch {
      width:28px; 
      height:28px; 
      border:2px solid transparent;
      border-radius:4px;
      cursor:pointer;
      transition: var(--transition);
    }
    
    #form-popup .color-palette .color-swatch.selected {
      border-color: var(--accent);
      transform: scale(1.1);
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      gap: 10px;
    }
    
    .form-actions button {
      padding:10px;
      color:#fff; 
      border:none; 
      border-radius:4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      flex: 1;
    }
    
    #form-save {
      background: var(--success);
    }
    
    #form-save:hover {
      background: #27ae60;
    }
    
    #form-delete {
      background: var(--danger);
      width: auto;
      padding: 10px 15px;
    }
    
    #form-delete:hover {
      background: #c0392b;
    }
    
    /* Image viewer */
    #image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    #image-viewer.visible {
      opacity: 1;
      pointer-events: all;
    }
    
    #image-viewer img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 4px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    /* Confirmation dialog */
    #confirm-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--primary);
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      text-align: center;
      display: none;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    #confirm-dialog p {
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .dialog-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .dialog-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .btn-confirm {
      background: var(--danger);
      color: white;
    }
    
    .btn-cancel {
      background: #7f8c8d;
      color: var(--text);
    }
    
    /* Zoom controls - Fixed position */
    #zoom-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--primary);
      padding: 10px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    .zoom-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--secondary);
      color: white;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .zoom-btn:hover {
      background: var(--accent);
    }
    
    #zoom-level {
      padding: 0 12px;
      font-size: 14px;
      font-weight: 500;
      min-width: 60px;
      text-align: center;
    }
    
    /* History controls - Fixed position (√† gauche) */
    #history-controls {
      position: fixed;
      top: 20px;
      left: 300px;
      z-index: 100;
      display: flex;
      gap: 8px;
      background: var(--primary);
      padding: 10px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    /* Style pour les boutons undo/redo */
    .history-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--secondary);
      color: white;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .history-btn:hover {
      background: var(--accent);
    }
    
    /* Link styling */
    .link-line {
      stroke-width: 3px;
      pointer-events: all;
    }
    
    .link-text {
      font-size: 12px;
      fill: var(--text);
      font-weight: 500;
      pointer-events: all;
      text-shadow: 
        -1px -1px 0 var(--primary), 
        1px -1px 0 var(--primary), 
        -1px 1px 0 var(--primary), 
        1px 1px 0 var(--primary);
    }
    
    /* Loading indicator */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      background: rgba(26, 26, 26, 0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: none;
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      #sidebar {
        width: 220px;
      }
      
      #controls-overlay {
        flex-wrap: wrap;
        max-width: 90%;
      }
      
      #history-controls {
        left: 240px;
      }
    }
  </style>
</head>
<body>

  <!-- NOUVELLE PAGE DE CONNEXION -->
  <div id="login-screen">
    <div class="login-container">
      <div class="left-panel">
        <!-- Image en background, rien d‚Äôautre -->
      </div>

      <div class="right-panel">
        <div class="login-box">
          <h3>Acc√®s S√©curis√©</h3>

          <div class="input-group">
            <label for="password">Mot de passe</label>
            <input
              type="password"
              id="password"
              placeholder="Entrez vos identifiants"
            />
          </div>

          <button class="login-btn" id="login-btn">Authentifier</button>
          <div id="login-error">Identifiants incorrects. Veuillez r√©essayer.</div>
          <div class="security-tag">Syst√®me S√©curis√© Niveau 5</div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <!-- sidebar pour g√©rer plusieurs tableaux -->
    <div id="sidebar">
      <div class="sidebar-header">
        <h2>Tableaux</h2>
      </div>
      <div class="sidebar-content">
        <button id="new-table">+ Nouveau tableau</button>
        <div id="table-list"></div>
      </div>
    </div>

    <!-- canvas + liens + contr√¥les superpos√©s -->
    <div id="canvas-container">
      <!-- Centered at top -->
      <div id="controls-overlay">
        <button data-type="person">Individus</button>
        <button data-type="element">Pi√®ces</button>
        <button data-type="link">Liaisons</button>
        <button data-type="import">Enqu√™tes</button>
      </div>
      
      <!-- Fixed position toolbar -->
      <div id="toolbar">
        <button id="export-png" class="export-option">Export PNG</button>
        <button id="export-pdf" class="export-option">Export PDF</button>
      </div>
      
      <!-- Fixed position history controls (√† gauche) -->
      <div id="history-controls">
        <button id="undo-btn" class="history-btn" title="Annuler">‚Ü©</button>
        <button id="redo-btn" class="history-btn" title="R√©tablir">‚Ü™</button>
      </div>
      
      <!-- Fixed position zoom controls -->
      <div id="zoom-controls">
        <button id="zoom-in" class="zoom-btn" title="Zoom avant">+</button>
        <div id="zoom-level">70%</div>
        <button id="zoom-out" class="zoom-btn" title="Zoom arri√®re">-</button>
      </div>
      
      <!-- Loading indicator -->
      <div class="loading" id="loading-indicator">Chargement...</div>
      
      <div id="canvas-wrapper">
        <svg id="link-svg"></svg>
        <div id="canvas"></div>
      </div>
    </div>
  </div>

  <!-- popup de formulaire -->
  <div id="form-popup">
    <h3 id="form-title"></h3>
    <div id="form-fields"></div>
    <div class="form-actions">
      <button id="form-delete" title="Supprimer">üóëÔ∏è</button>
      <button id="form-save">Sauvegarder</button>
    </div>
  </div>
  
  <!-- image viewer -->
  <div id="image-viewer">
    <img id="viewed-image" src="" alt="Agrandissement"/>
  </div>
  
  <!-- confirmation dialog -->
  <div id="confirm-dialog">
    <p>√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?</p>
    <div class="dialog-buttons">
      <button class="btn-cancel">Annuler</button>
      <button class="btn-confirm">Supprimer</button>
    </div>
  </div>

  <script>
  (function(){
    const SECRET = 'secret123';
    const loginScreen = document.getElementById('login-screen');
    const app         = document.getElementById('app');
    const pwdInput    = document.getElementById('password');
    const loginBtn    = document.getElementById('login-btn');
    const loginError  = document.getElementById('login-error');
    
    // Add event listeners
    loginBtn.onclick = doLogin;
    pwdInput.onkeydown = e => { 
      if(e.key === 'Enter') doLogin(); 
    };
    
    function doLogin(){
      if(pwdInput.value === SECRET){
        loginScreen.style.display = 'none';
        app.style.display = 'flex';
        init();
      } else {
        loginError.style.display = 'block';
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 5000);
      }
      pwdInput.value = '';
    }

    function init(){
      /*** Variables et Data ***/
      let tableaux = JSON.parse(localStorage.getItem('tabs') || '[]');
      let curIdx   = null;
      let history = {
        past: [],
        future: [],
        addState: function(state) {
          this.past.push(JSON.stringify(state));
          this.future = [];
        },
        undo: function() {
          if (this.past.length > 1) {
            this.future.push(this.past.pop());
            return JSON.parse(this.past[this.past.length - 1]);
          }
          return null;
        },
        redo: function() {
          if (this.future.length > 0) {
            const state = this.future.pop();
            this.past.push(state);
            return JSON.parse(state);
          }
          return null;
        }
      };
      
      const canvasC = document.getElementById('canvas-container');
      const canvasWrapper = document.getElementById('canvas-wrapper');
      const canvas  = document.getElementById('canvas');
      const linkSvg = document.getElementById('link-svg');
      const tblList = document.getElementById('table-list');
      const newTable= document.getElementById('new-table');
      const overlay = document.getElementById('controls-overlay');
      const popup   = document.getElementById('form-popup');
      const fld     = document.getElementById('form-fields');
      const titleEl = document.getElementById('form-title');
      const saveBtn = document.getElementById('form-save');
      const deleteBtn = document.getElementById('form-delete');
      const exportPng = document.getElementById('export-png');
      const exportPdf = document.getElementById('export-pdf');
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');
      const zoomIn = document.getElementById('zoom-in');
      const zoomOut = document.getElementById('zoom-out');
      const zoomLevel = document.getElementById('zoom-level');
      const imageViewer = document.getElementById('image-viewer');
      const viewedImage = document.getElementById('viewed-image');
      const confirmDialog = document.getElementById('confirm-dialog');
      const confirmBtn = confirmDialog.querySelector('.btn-confirm');
      const cancelBtn = confirmDialog.querySelector('.btn-cancel');
      const loadingIndicator = document.getElementById('loading-indicator');

      const COLORS = [
        '#000000','#e6194b','#3cb44b','#ffe119',
        '#4363d8','#f58231','#911eb4','#46f0f0',
        '#f032e6','#bcf60c'
      ];
      let scale = 0.7;
      let deleteCallback = null;
      let isEditing = false;
      let editLink = null;
      let dragEl = null, startX, startY, initialX, initialY;
      let importedGroups = {};
      let isPanning = false, panX, panY;
      let lastZoomTime = 0;
      const ZOOM_SENSITIVITY = 0.001;
      const ZOOM_ANIMATION_DURATION = 200;

      // Variables pour l'optimisation des performances
      let isDragging = false;
      let animationFrameId = null;

      // Initialize canvas position to center
      setTimeout(() => {
        centerCanvas();
        updateZoomLevel();
      }, 100);

      /* Zoom functionality - CORRIG√â: zoom sur la position du pointeur */
      function updateZoom() {
        canvas.style.transform = `translate(-50%, -50%) scale(${scale})`;
        linkSvg.style.transform = `translate(-50%, -50%) scale(${scale})`;
        updateZoomLevel();
      }
      
      function updateZoomLevel() {
        zoomLevel.textContent = Math.round(scale * 100) + '%';
      }
      
      function smoothZoom(targetScale, clientX, clientY) {
        const startScale = scale;
        const startTime = performance.now();
        
        // Get current scroll position
        const scrollLeftBefore = canvasC.scrollLeft;
        const scrollTopBefore = canvasC.scrollTop;
        
        // Calculate mouse position relative to canvas container
        const rect = canvasC.getBoundingClientRect();
        const mouseX = (clientX - rect.left + scrollLeftBefore) / scale;
        const mouseY = (clientY - rect.top + scrollTopBefore) / scale;
        
        function animateZoom(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / ZOOM_ANIMATION_DURATION, 1);
          
          // Easing function for smooth animation
          const easeProgress = 1 - Math.pow(1 - progress, 3);
          
          scale = startScale + (targetScale - startScale) * easeProgress;
          updateZoom();
          
          // Calculate new scroll position to zoom on pointer
          if (progress < 1) {
            requestAnimationFrame(animateZoom);
          } else {
            // Final scroll adjustment to keep the pointer fixed
            const newMouseX = mouseX * scale;
            const newMouseY = mouseY * scale;
            
            canvasC.scrollLeft = newMouseX - (clientX - rect.left);
            canvasC.scrollTop = newMouseY - (clientY - rect.top);
          }
        }
        
        requestAnimationFrame(animateZoom);
      }
      
      canvasC.addEventListener('wheel', e => {
        e.preventDefault();
        const now = performance.now();
        
        // Limiter la fr√©quence du zoom pour plus de fluidit√©
        if (now - lastZoomTime < 16) return;
        lastZoomTime = now;
        
        const delta = e.deltaY * ZOOM_SENSITIVITY;
        const newScale = Math.min(3, Math.max(0.21, scale - delta)); // Chang√© de 0.1 √† 0.21 (21%)
        
        smoothZoom(newScale, e.clientX, e.clientY);
      });
      
      zoomIn.addEventListener('click', () => {
        const rect = canvasC.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        smoothZoom(Math.min(3, scale + 0.1), centerX, centerY);
      });
      
      zoomOut.addEventListener('click', () => {
        const rect = canvasC.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        smoothZoom(Math.max(0.21, scale - 0.1), centerX, centerY); // Chang√© de 0.1 √† 0.21 (21%)
      });

      /* Pan by dragging background - OPTIMIS√â */
      function handlePanning(e) {
        if (!isPanning) return;
        
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        
        animationFrameId = requestAnimationFrame(() => {
          const dx = e.clientX - panX;
          const dy = e.clientY - panY;
          
          canvasC.scrollLeft -= dx;
          canvasC.scrollTop -= dy;
          
          panX = e.clientX;
          panY = e.clientY;
        });
      }
      
      canvasC.addEventListener('pointerdown', e => {
        if(e.target === canvasC || e.target === canvas || e.target === canvasWrapper || e.target === linkSvg){
          isPanning = true;
          panX = e.clientX; 
          panY = e.clientY;
          canvasC.style.cursor = 'grabbing';
          canvasC.classList.add('panning');
          e.preventDefault();
        }
      });
      
      canvasC.addEventListener('pointermove', handlePanning);
      
      canvasC.addEventListener('pointerup', e => {
        if(isPanning){
          isPanning = false; 
          canvasC.style.cursor = 'grab';
          canvasC.classList.remove('panning');
          e.preventDefault();
        }
      });
      
      canvasC.addEventListener('pointerleave', e => {
        if(isPanning){
          isPanning = false; 
          canvasC.style.cursor = 'grab';
          canvasC.classList.remove('panning');
        }
      });

      /* Image viewer */
      function openImageViewer(src) {
        viewedImage.src = src;
        imageViewer.classList.add('visible');
      }
      
      imageViewer.addEventListener('click', () => {
        imageViewer.classList.remove('visible');
      });

      /* Confirmation dialog */
      function openConfirmDialog(callback) {
        deleteCallback = callback;
        confirmDialog.style.display = 'block';
      }
      
      confirmBtn.addEventListener('click', () => {
        if (deleteCallback) deleteCallback();
        confirmDialog.style.display = 'none';
      });
      
      cancelBtn.addEventListener('click', () => {
        confirmDialog.style.display = 'none';
      });

      /* Loading indicator */
      function showLoading() {
        loadingIndicator.style.display = 'block';
      }
      
      function hideLoading() {
        loadingIndicator.style.display = 'none';
      }

      /* gestion des tableaux */
      newTable.onclick = () => {
        const n = prompt('Nom du tableau:');
        if(!n) return;
        
        const newTab = { 
          id: Date.now(), 
          name: n, 
          nodes: [], 
          links: [], 
          imports: [] 
        };
        
        tableaux.push(newTab);
        saveTabs(); 
        genList(); 
        switchTo(tableaux.length - 1);
      };
      
      function genList(){
        tblList.innerHTML = '';
        tableaux.forEach((t, i) => {
          const b = document.createElement('div');
          b.className = 'table-btn';
          if(i === curIdx) b.classList.add('active');
          
          b.innerHTML = `
            <span>${t.name}</span>
            <div class="table-actions">
              <button class="icon-btn" data-action="rename" title="Renommer">‚úèÔ∏è</button>
              <button class="icon-btn" data-action="delete" title="Supprimer">üóëÔ∏è</button>
            </div>
          `;
          
          b.onclick = () => switchTo(i);
          
          // Add rename functionality
          const renameBtn = b.querySelector('[data-action="rename"]');
          renameBtn.onclick = (e) => {
            e.stopPropagation();
            const newName = prompt('Nouveau nom du tableau:', t.name);
            if (newName && newName !== t.name) {
              t.name = newName;
              saveTabs();
              genList();
            }
          };
          
          // Add delete functionality
          const deleteBtn = b.querySelector('[data-action="delete"]');
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            openConfirmDialog(() => {
              tableaux.splice(i, 1);
              saveTabs();
              genList();
              if (tableaux.length > 0) {
                switchTo(0);
              } else {
                canvas.innerHTML = '';
                linkSvg.innerHTML = '';
              }
            });
          };
          
          tblList.appendChild(b);
        });
      }
      
      function saveTabs(){ 
        localStorage.setItem('tabs', JSON.stringify(tableaux)); 
        // Save to history
        if (curIdx !== null) {
          history.addState(tableaux[curIdx]);
          updateHistoryButtons();
        }
      }

      function switchTo(i){
        showLoading();
        setTimeout(() => {
          curIdx = i; 
          genList(); 
          redraw();
          
          // Add to history
          history.addState(tableaux[curIdx]);
          updateHistoryButtons();
          hideLoading();
        }, 100);
      }
      
      function updateHistoryButtons() {
        undoBtn.disabled = history.past.length <= 1;
        redoBtn.disabled = history.future.length === 0;
      }
      
      // Undo/Redo functionality
      undoBtn.addEventListener('click', () => {
        const state = history.undo();
        if (state) {
          tableaux[curIdx] = state;
          redraw();
          updateHistoryButtons();
        }
      });
      
      redoBtn.addEventListener('click', () => {
        const state = history.redo();
        if (state) {
          tableaux[curIdx] = state;
          redraw();
          updateHistoryButtons();
        }
      });

      /* initial draw */
      if(tableaux.length) switchTo(0);

      /* popup logic */
      let editNode = null;
      overlay.onclick = e => {
        const type = e.target.dataset.type;
        if(!type) return;
        isEditing = false;
        editLink = null;
        openForm(type);
      };
      
      saveBtn.onclick = submitForm;
      deleteBtn.onclick = () => {
        if (isEditing && editNode) {
          openConfirmDialog(() => {
            const cur = getCur();
            // Remove node
            const index = cur.nodes.findIndex(node => node.id === editNode.id);
            if (index !== -1) {
              cur.nodes.splice(index, 1);
            }
            
            // Remove links connected to this node
            cur.links = cur.links.filter(link => 
              link.src !== editNode.id && link.tgt !== editNode.id
            );
            
            saveTabs();
            redraw();
            popup.style.display = 'none';
          });
        } else if (editLink) {
          openConfirmDialog(() => {
            const cur = getCur();
            // Remove link
            const index = cur.links.findIndex(link => link.id === editLink.id);
            if (index !== -1) {
              cur.links.splice(index, 1);
            }
            
            saveTabs();
            redraw();
            popup.style.display = 'none';
          });
        }
      };
      
      function openForm(type, link = null){
        popup.style.display = 'block';
        fld.innerHTML = ''; 
        
        if (link) {
          editLink = link;
          isEditing = true;
          titleEl.textContent = 'Modifier la liaison';
          
          // Cr√©er deux listes distinctes pour source et cible
          let srcOpts = '<option value="">‚Äî</option>';
          let tgtOpts = '<option value="">‚Äî</option>';
          
          getCur().nodes.forEach(n => {
            const label = n.data.label.length > 20 ? n.data.label.substring(0, 20) + '...' : n.data.label;
            const selectedSrc = n.id === link.src ? 'selected' : '';
            const selectedTgt = n.id === link.tgt ? 'selected' : '';
            
            srcOpts += `<option value="${n.id}" ${selectedSrc}>${label}</option>`;
            tgtOpts += `<option value="${n.id}" ${selectedTgt}>${label}</option>`;
          });
          
          // palette
          let pal = '<div class="color-palette">';
          COLORS.forEach((c, i) => {
            const selected = c === link.color ? 'selected' : '';
            pal += `<div class="color-swatch ${selected}" data-color="${c}" style="background:${c}"></div>`;
          });
          pal += '</div>';
          
          fld.innerHTML = `
            <label>Source<select id="f-src">${srcOpts}</select></label>
            <label>Cible<select id="f-tgt">${tgtOpts}</select></label>
            <label>Couleur</label>${pal}
            <label>Titre<input id="f-link-title" value="${link.title || ''}"/></label>
          `;
          
          // clic couleur
          fld.querySelectorAll('.color-swatch').forEach(s => {
            s.onclick = e => {
              fld.querySelectorAll('.color-swatch').forEach(x => {
                x.classList.remove('selected');
              });
              e.target.classList.add('selected');
            };
          });
          
          deleteBtn.style.display = 'block';
          return;
        }
        
        titleEl.textContent = ({
          person: isEditing ? 'Modifier l\'individu' : 'Nouvel Individu',
          element: isEditing ? 'Modifier la pi√®ce' : 'Nouvelle Pi√®ce',
          link: 'Nouvelle Liaison',
          import: 'Importer Tableau'
        })[type] || 'Formulaire';
        
        // construire champs
        if(type === 'person'){
          fld.innerHTML = `
            <label>Nom<input id="f-name" value="${isEditing ? editNode.data.name || '' : ''}"/></label>
            <label>Pr√©nom<input id="f-first" value="${isEditing ? editNode.data.first || '' : ''}"/></label>
            <label>Civilit√©
              <select id="f-gender">
                <option ${isEditing && editNode.data.gender === 'Homme' ? 'selected' : ''}>Homme</option>
                <option ${isEditing && editNode.data.gender === 'Femme' ? 'selected' : ''}>Femme</option>
              </select>
            </label>
            <label>√Çge<input type="number" id="f-age" value="${isEditing ? editNode.data.age || '' : ''}"/></label>
            <label>Organisation<input id="f-org" value="${isEditing ? editNode.data.org || '' : ''}"/></label>
            <label>Photo<input type="file" id="f-photo" accept="image/*"/></label>
            ${isEditing && editNode.data.img ? `<img src="${editNode.data.img}" style="max-width: 100px; max-height: 100px; margin-top: 10px;" />` : ''}
          `;
        }
        
        if(type === 'element'){
          fld.innerHTML = `
            <label>Type
              <select id="f-etype">
                <option ${isEditing && editNode.data.type === 'Preuve' ? 'selected' : ''}>Preuve</option>
                <option ${isEditing && editNode.data.type === 'Activit√©' ? 'selected' : ''}>Activit√©</option>
                <option ${isEditing && editNode.data.type === 'Lieu' ? 'selected' : ''}>Lieu</option>
                <option ${isEditing && editNode.data.type === 'Autre' ? 'selected' : ''}>Autre</option>
              </select>
            </label>
            <label>Titre<input id="f-title" value="${isEditing ? editNode.data.title || '' : ''}"/></label>
            <label>Note<textarea id="f-note">${isEditing ? editNode.data.note || '' : ''}</textarea></label>
            <label>Photos<input type="file" id="f-photos" multiple accept="image/*"/></label>
            ${isEditing && editNode.data.imgs && editNode.data.imgs.length > 0 ? 
              editNode.data.imgs.map(img => `<img src="${img}" style="max-width: 100px; max-height: 100px; margin: 5px;" />`).join('') : ''}
          `;
        }
        
        if(type === 'link'){
          // remplir selects - deux listes distinctes
          let srcOpts = '<option value="">‚Äî</option>';
          let tgtOpts = '<option value="">‚Äî</option>';
          
          getCur().nodes.forEach(n => {
            const label = n.data.label.length > 20 ? n.data.label.substring(0, 20) + '...' : n.data.label;
            srcOpts += `<option value="${n.id}">${label}</option>`;
            tgtOpts += `<option value="${n.id}">${label}</option>`;
          });
          
          // palette
          let pal = '<div class="color-palette">';
          COLORS.forEach((c, i) => {
            const selected = i === 0 ? 'selected' : '';
            pal += `<div class="color-swatch ${selected}" data-color="${c}" style="background:${c}"></div>`;
          });
           pal += '</div>';
          
          fld.innerHTML = `
            <label>Source<select id="f-src">${srcOpts}</select></label>
            <label>Cible<select id="f-tgt">${tgtOpts}</select></label>
            <label>Couleur</label>${pal}
            <label>Titre<input id="f-link-title"/></label>
          `;
          
          // clic couleur
          fld.querySelectorAll('.color-swatch').forEach(s => {
            s.onclick = e => {
              fld.querySelectorAll('.color-swatch').forEach(x => {
                x.classList.remove('selected');
              });
              e.target.classList.add('selected');
            };
          });
        }
        
        if(type === 'import'){
          let opts = '<option value="">‚Äî</option>';
          tableaux.forEach(t => {
            if(t.id !== getCur().id) {
              opts += `<option value="${t.id}">${t.name}</option>`;
            }
          });
          
          fld.innerHTML = `
            <label>Tableau<select id="f-import">${opts}</select></label>
          `;
        }
        
        popup.dataset.type = type;
        deleteBtn.style.display = isEditing ? 'block' : 'none';
      }
      
      /* close form if clic hors */
      document.addEventListener('pointerdown', e => {
        if(popup.style.display === 'block' && !popup.contains(e.target)) {
          popup.style.display = 'none';
        }
      });

       function submitForm(){
        const type = popup.dataset.type;
        const cur  = getCur();
        
        if (editLink) {
          // Modification d'une liaison existante
          const src = fld.querySelector('#f-src').value;
          const tgt = fld.querySelector('#f-tgt').value;
          const title = fld.querySelector('#f-link-title').value.trim();
          const sw  = fld.querySelector('.color-swatch.selected');
          const color = sw ? sw.dataset.color : '#000';
          
          if(!src || !tgt) return alert('Source et cible requises');
          if(src === tgt) return alert('La source et la cible doivent √™tre diff√©rentes');
          
          // Mettre √† jour la liaison
          editLink.src = src;
          editLink.tgt = tgt;
          editLink.title = title;
          editLink.color = color;
          
          saveTabs(); 
          redraw(); 
          popup.style.display = 'none';
          editLink = null;
          return;
         }
        
        if(type === 'person'){
            // lire champs
            const name  = fld.querySelector('#f-name').value.trim();
            const first = fld.querySelector('#f-first').value.trim();
            const gender = fld.querySelector('#f-gender').value;
            const age   = fld.querySelector('#f-age').value;
            const org   = fld.querySelector('#f-org').value.trim();
            const file  = fld.querySelector('#f-photo').files[0];
            
            if(!name || !first) return alert('Nom/Pr√©nom requis');
            
            let imgData = isEditing && editNode.data.img ? editNode.data.img : null;
            if(file){
                const r = new FileReader();
                r.onload = e => {
                    imgData = e.target.result;
                    finalize();
                };
                r.readAsDataURL(file);
            } else {
                finalize();
            }
            
            function finalize(){
                const nodeData = {
                    label: `${first} ${name}`,
                    name, first, gender, age, org, img: imgData
                };
                
                if (isEditing && editNode) {
                    // Update existing node
                    editNode.data = nodeData;
                } else {
                    // Create new node
                    const node = {
                        id: Date.now().toString(),
                        type: 'person',
                        data: nodeData,
                        x: 100, 
                        y: 100
                    };
                    cur.nodes.push(node);
                }
                
                saveTabs(); 
                redraw(); 
                popup.style.display = 'none';
            }
        }
        
        if(type === 'element'){
          const etype = fld.querySelector('#f-etype').value;
          const title = fld.querySelector('#f-title').value.trim();
          const note  = fld.querySelector('#f-note').value.trim();
          const files = fld.querySelector('#f-photos').files;
          
          if(!title) return alert('Titre requis');
          
          // If editing, keep existing images
          let imgs = isEditing && editNode.data.imgs ? editNode.data.imgs : [];
          
          let count = files.length;
          if(count > 0){
            Array.from(files).forEach(f => {
              const r = new FileReader();
              r.onload = e => {
                imgs.push(e.target.result);
                if(--count === 0) finalize();
              };
              r.readAsDataURL(f);
            });
          } else {
            finalize();
          }
          
          function finalize(){
            const nodeData = { 
              label: title, 
              type: etype, 
              title, 
              note, 
              imgs 
            };
            
            if (isEditing && editNode) {
              // Update existing node
              editNode.data = nodeData;
            } else {
              // Create new node
              const node = {
                id: Date.now().toString(),
                type: 'element',
                data: nodeData,
                x: 140, 
                y: 140
              };
              cur.nodes.push(node);
            }
            
            saveTabs(); 
            redraw(); 
            popup.style.display = 'none';
          }
        }
        
        if(type === 'link'){
          const src = fld.querySelector('#f-src').value;
          const tgt = fld.querySelector('#f-tgt').value;
          const title = fld.querySelector('#f-link-title').value.trim();
          const sw  = fld.querySelector('.color-swatch.selected');
          const color = sw ? sw.dataset.color : '#000';
          
          if(!src || !tgt) return alert('Source et cible requises');
          if(src === tgt) return alert('La source et la cible doivent √™tre diff√©rentes');
          
          const l = { 
            id: Date.now().toString(), 
            src, 
            tgt, 
            color, 
            title 
          };
          
          cur.links.push(l);
          saveTabs(); 
          redraw(); 
          popup.style.display = 'none';
        }
        
        if(type === 'import'){
          const impId = fld.querySelector('#f-import').value;
          if(!impId) return alert('Choisir un tableau');
          
          const srcTab = tableaux.find(t => t.id == impId);
          if (!srcTab) return alert('Tableau source introuvable');
          
          // Import nodes from source table
          const newNodes = JSON.parse(JSON.stringify(srcTab.nodes));
          
          // Calculer la bounding box des n≈ìuds import√©s
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          
          newNodes.forEach(node => {
            if (node.x < minX) minX = node.x;
            if (node.y < minY) minY = node.y;
            if (node.x + 160 > maxX) maxX = node.x + 160; // 160 est la largeur approximative d'un n≈ìud
            if (node.y + 200 > maxY) maxY = node.y + 200; // 200 est la hauteur approximative d'un n≈ìud
          });
          
          // Ajouter une marge de 20px
          minX -= 20;
          minY -= 20;
          maxX += 20;
          maxY += 20;
          
          const width = maxX - minX;
          const height = maxY - minY;
          
          // Center the imported nodes in the current view
          const viewportCenterX = canvasC.scrollLeft + canvasC.clientWidth / 2;
          const viewportCenterY = canvasC.scrollTop + canvasC.clientHeight / 2;
          
          // Calculate offset to center the imported nodes
          const centerX = (minX + maxX) / 2;
          const centerY = (minY + maxY) / 2;
          const offsetX = viewportCenterX - centerX;
          const offsetY = viewportCenterY - centerY;
          
          // Apply offset to all nodes
          newNodes.forEach(node => {
            node.x += offsetX;
            node.y += offsetY;
            node.imported = true;
            node.importedFrom = impId;
          });
          
          // Add nodes to current table
          cur.nodes.push(...newNodes);
          
          // Import links from source table
          const newLinks = JSON.parse(JSON.stringify(srcTab.links));
          newLinks.forEach(link => {
            link.imported = true;
            link.importedFrom = impId;
          });
          cur.links.push(...newLinks);
          
          // Create imported group frame
          const groupId = 'imported-' + Date.now();
          const group = {
            id: groupId,
            x: minX + offsetX,
            y: minY + offsetY,
            width: width,
            height: height,
            sourceTable: impId,
            nodes: newNodes.map(n => n.id),
            links: newLinks.map(l => l.id)
          };
          
          if (!cur.imports) cur.imports = [];
          cur.imports.push(group);
          
          saveTabs(); 
          redraw(); 
          popup.style.display = 'none';
        }
      }

      /* get current tableau */
      function getCur(){ 
        return tableaux[curIdx] || { nodes: [], links: [], imports: [] }; 
      }

      /* redraw tout */
      function redraw(){
        canvas.innerHTML = ''; 
        linkSvg.innerHTML = '';
        const cur = getCur();
        
        // Draw imported groups first (behind everything)
        if (cur.imports) {
          cur.imports.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'imported-group';
            groupDiv.style.left = group.x + 'px';
            groupDiv.style.top = group.y + 'px';
            groupDiv.style.width = group.width + 'px';
            groupDiv.style.height = group.height + 'px';
            groupDiv.dataset.id = group.id;
            
            // Header avec le nom du tableau source
            const headerDiv = document.createElement('div');
            headerDiv.className = 'group-header';
            const srcTab = tableaux.find(t => t.id == group.sourceTable);
            headerDiv.textContent = srcTab ? `Import: ${srcTab.name}` : 'Import';
            groupDiv.appendChild(headerDiv);
            
            // Contr√¥les du groupe
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'group-controls';
            
            // Bouton de suppression
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'group-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Supprimer le groupe import√©';
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              openConfirmDialog(() => {
                // Supprimer les n≈ìuds du groupe
                group.nodes.forEach(nodeId => {
                  const index = cur.nodes.findIndex(n => n.id === nodeId);
                  if (index !== -1) cur.nodes.splice(index, 1);
                });
                
                // Supprimer les liens du groupe
                group.links.forEach(linkId => {
                  const index = cur.links.findIndex(l => l.id === linkId);
                  if (index !== -1) cur.links.splice(index, 1);
                });
                
                // Supprimer le groupe
                const groupIndex = cur.imports.findIndex(g => g.id === group.id);
                if (groupIndex !== -1) cur.imports.splice(groupIndex, 1);
                
                saveTabs();
                redraw();
              });
            };
            
            // Poign√©e de d√©placement
            const moveHandle = document.createElement('div');
            moveHandle.className = 'group-handle';
            moveHandle.innerHTML = '‚§ß';
            moveHandle.title = 'D√©placer le groupe';
            
            controlsDiv.appendChild(deleteBtn);
            groupDiv.appendChild(controlsDiv);
            groupDiv.appendChild(moveHandle);
            
            // Rendre le groupe d√©pla√ßable
            makeGroupDraggable(groupDiv, group, cur);
            
            canvas.appendChild(groupDiv);
          });
        }
        
        // nodes
        cur.nodes.forEach(n => {
          const d = document.createElement('div');
          d.className = 'node'; 
          d.dataset.id = n.id;
          d.style.left = n.x + 'px'; 
          d.style.top = n.y + 'px';
          
          // contenu vertical
          if(n.type === 'person'){
            d.innerHTML = `
              ${n.data.img ? `<img src="${n.data.img}" alt="${n.data.first} ${n.data.name}" />` : '<div style="height:120px; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; color:#999;">Aucune image</div>'}
              <strong>${n.data.first} ${n.data.name}</strong><br>
              ${n.data.gender}, ${n.data.age} ans<br>
              <em>Organisation: ${n.data.org}</em>
            `;
          } else {
            let pics = '';
            if (n.data.imgs && n.data.imgs.length > 0) {
              n.data.imgs.forEach(u => {
                pics += `<img src="${u}" alt="${n.data.title}" />`;
              });
            } else {
              pics = '<div style="height:120px; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; color:#999;">Aucune image</div>';
            }
            d.innerHTML = `
              ${pics}
              <strong>[${n.data.type}] ${n.data.title}</div>
            `;
          }
          
          // Add image click event
          d.querySelectorAll('img').forEach(img => {
            img.addEventListener('click', e => {
              e.stopPropagation();
              openImageViewer(e.target.src);
            });
          });
          
          // drag avec meilleur suivi - OPTIMIS√â
          d.addEventListener('pointerdown', startDragNode);
          
          // double click to edit
          d.addEventListener('dblclick', e => {
            e.stopPropagation();
            editNode = n;
            isEditing = true;
            openForm(n.type);
          });
          
          canvas.appendChild(d);
        });
        
        // links (drawn behind nodes)
        const linkGroups = {};
        
        // Regrouper les liens par paire de n≈ìuds
        cur.links.forEach(l => {
          const key = [l.src, l.tgt].sort().join('-');
          if (!linkGroups[key]) {
            linkGroups[key] = [];
          }
          linkGroups[key].push(l);
        });
        
        // Dessiner les liens group√©s
        Object.values(linkGroups).forEach(group => {
          if (group.length === 1) {
            // Un seul lien - dessiner normalement
            drawLink(group[0]);
          } else {
            // Multiple liens - dessiner en parall√®le
            group.forEach((l, index) => {
              drawLink(l, index, group.length);
            });
          }
        });
      }
      
      /* Fonction pour dessiner un lien avec d√©calage optionnel - AM√âLIOR√âE */
      function drawLink(l, index = 0, total = 1) {
        const a = document.querySelector(`.node[data-id="${l.src}"]`);
        const b = document.querySelector(`.node[data-id="${l.tgt}"]`);
        if(!a || !b) return;

        // Calculer centres
        const aCenterX = parseInt(a.style.left) + a.offsetWidth / 2;
        const aCenterY = parseInt(a.style.top) + a.offsetHeight / 2;
        const bCenterX = parseInt(b.style.left) + b.offsetWidth / 2;
        const bCenterY = parseInt(b.style.top) + b.offsetHeight / 2;

        // Angle entre les n≈ìuds
        const dx = bCenterX - aCenterX;
        const dy = bCenterY - aCenterY;
        const angle = Math.atan2(dy, dx);

        // Points de base
        const x1 = aCenterX;
        const y1 = aCenterY;
        const x2 = bCenterX;
        const y2 = bCenterY;

        // üîπ D√©finir l‚Äôespacement des liens
        const spacing = 25; // espace entre les traits
        const offset = (index - (total - 1) / 2) * spacing;

        // D√©calage perpendiculaire
        const offsetX = offset * Math.sin(angle);
        const offsetY = offset * -Math.cos(angle);

        // Appliquer d√©calage
        const x1_off = x1 + offsetX;
        const y1_off = y1 + offsetY;
        const x2_off = x2 + offsetX;
        const y2_off = y2 + offsetY;

        // LIGNE
        const ln = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ln.setAttribute('x1', x1_off);
        ln.setAttribute('y1', y1_off);
        ln.setAttribute('x2', x2_off);
        ln.setAttribute('y2', y2_off);
        ln.setAttribute('stroke', l.color);
        ln.setAttribute('stroke-width', '3');
        ln.setAttribute('class', 'link-line');
        ln.dataset.id = l.id;
        
        // Double-click to edit link
        ln.addEventListener('dblclick', e => {
          e.stopPropagation();
          openForm('link', l);
        });
        
        linkSvg.appendChild(ln);

        // TEXTE
        if(l.title){
          const midX = (x1_off + x2_off) / 2;
          const midY = (y1_off + y2_off) / 2;

          // D√©calage suppl√©mentaire pour le texte (au-dessus de la ligne)
          const textOffset = 15;
          const textX = midX + textOffset * Math.sin(angle);
          const textY = midY + textOffset * -Math.cos(angle);

          const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          txt.setAttribute('x', textX);
          txt.setAttribute('y', textY);
          txt.setAttribute('text-anchor', 'middle');
          txt.setAttribute('class', 'link-text');
          txt.textContent = l.title;

          // √âviter que le texte soit √† l'envers
          let textAngle = angle * 180 / Math.PI;
          if (textAngle > 90) textAngle -= 180;
          if (textAngle < -90) textAngle += 180;
          
          txt.setAttribute('transform', `rotate(${textAngle}, ${textX}, ${textY})`);
          
          // Double-click to edit link
          txt.addEventListener('dblclick', e => {
            e.stopPropagation();
            openForm('link', l);
          });
          
          linkSvg.appendChild(txt);
        }
      }
      
      /* drag node avec meilleur suivi - OPTIMIS√â */
      function startDragNode(e) {
        if (e.button !== 0) return;
        e.stopPropagation();
        dragEl = e.currentTarget;
        
        // Get initial positions
        startX = e.clientX;
        startY = e.clientY;
        initialX = parseInt(dragEl.style.left);
        initialY = parseInt(dragEl.style.top);
        
        dragEl.style.cursor = 'grabbing';
        dragEl.style.zIndex = '20';
        dragEl.classList.add('dragging');
        
        // Prevent text selection during drag
        document.body.style.userSelect = 'none';
        
        isDragging = true;
        document.addEventListener('pointermove', dragNode);
        document.addEventListener('pointerup', stopDragNode);
      }
      
      function dragNode(e) {
        if (!isDragging) return;
        
        // Utilisation de requestAnimationFrame pour fluidit√©
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        
        animationFrameId = requestAnimationFrame(() => {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          
          // Utilisation de translate3d pour l'acc√©l√©ration GPU
          dragEl.style.transform = `translate3d(${dx}px, ${dy}px, 0)`;
        });
      }
      
      function stopDragNode(e) {
        if (!isDragging) return;
        
        isDragging = false;
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        }
        
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const newX = initialX + dx;
        const newY = initialY + dy;
        
        // Update node position in data
        const id = dragEl.dataset.id;
        const node = getCur().nodes.find(n => n.id === id);
        if (node) {
          node.x = newX;
          node.y = newY;
          saveTabs();
        }
        
        // Reset transform and update position
        dragEl.style.transform = 'none';
        dragEl.style.left = newX + 'px';
        dragEl.style.top = newY + 'px';
        
        dragEl.style.cursor = 'grab';
        dragEl.style.zIndex = '10';
        dragEl.classList.remove('dragging');
        
        // Restore text selection
        document.body.style.userSelect = '';
        
        // Redessiner les liens une seule fois √† la fin
        redrawLinks();
        
        document.removeEventListener('pointermove', dragNode);
        document.removeEventListener('pointerup', stopDragNode);
      }
      
      function makeGroupDraggable(element, group, cur) {
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        element.addEventListener('pointerdown', (e) => {
          if (e.target === element || e.target.classList.contains('group-handle')) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialX = group.x;
            initialY = group.y;
            e.stopPropagation();
          }
        });
        
        document.addEventListener('pointermove', (e) => {
          if (!isDragging) return;
          
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          
          // Mettre √† jour la position du groupe
          group.x = initialX + dx;
          group.y = initialY + dy;
          
          // Mettre √† jour tous les n≈ìuds du groupe
          group.nodes.forEach(nodeId => {
            const node = cur.nodes.find(n => n.id === nodeId);
            if (node) {
              node.x += dx;
              node.y += dy;
            }
          });
          
          // Redessiner
          redraw();
        });
        
        document.addEventListener('pointerup', () => {
          if (isDragging) {
            isDragging = false;
            saveTabs(); // Sauvegarder apr√®s d√©placement
          }
        });
      }
      
      /* redrawLinks */
      function redrawLinks() {
        // Clear existing links
        const links = linkSvg.querySelectorAll('.link-line, .link-text');
        links.forEach(link => link.remove());
        
        const cur = getCur();
        const linkGroups = {};
        
        // Regrouper les liens par paire de n≈ìuds
        cur.links.forEach(l => {
          const key = [l.src, l.tgt].sort().join('-');
          if (!linkGroups[key]) {
            linkGroups[key] = [];
          }
          linkGroups[key].push(l);
        });
        
        // Dessiner les liens group√©s
        Object.values(linkGroups).forEach(group => {
          if (group.length === 1) {
            // Un seul lien - dessiner normalement
            drawLink(group[0]);
          } else {
            // Multiple liens - dessiner en parall√®le
            group.forEach((l, index) => {
              drawLink(l, index, group.length);
            });
          }
        });
      }
      
      /* Center canvas function */
      function centerCanvas() {
        const canvasRect = canvas.getBoundingClientRect();
        const scaledWidth = canvasRect.width * scale;
        const scaledHeight = canvasRect.height * scale;
        
        // Calculate scroll position to center the canvas
        canvasC.scrollLeft = (canvasWrapper.scrollWidth - canvasC.clientWidth) / 2;
        canvasC.scrollTop = (canvasWrapper.scrollHeight - canvasC.clientHeight) / 2;
      }
      
      /* Export functionality */
      exportPng.addEventListener('click', () => {
        showLoading();
        
        // Create a temporary container for export
        const exportContainer = document.createElement('div');
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.width = canvasWrapper.offsetWidth + 'px';
        exportContainer.style.height = canvasWrapper.offsetHeight + 'px';
        
        // Clone the canvas and SVG
        const canvasClone = canvas.cloneNode(true);
        const svgClone = linkSvg.cloneNode(true);
        
        // Adjust styles for export
        canvasClone.style.transform = 'translate(-50%, -50%) scale(1)';
        canvasClone.style.position = 'absolute';
        canvasClone.style.top = '50%';
        canvasClone.style.left = '50%';
        
        svgClone.style.transform = 'translate(-50%, -50%) scale(1)';
        svgClone.style.position = 'absolute';
        svgClone.style.top = '50%';
        svgClone.style.left = '50%';
        
        exportContainer.appendChild(canvasClone);
        exportContainer.appendChild(svgClone);
        document.body.appendChild(exportContainer);
        
        // Use html2canvas to capture the content
        html2canvas(exportContainer, {
          backgroundColor: '#0a0a1f',
          scale: 2
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `organigramme-${new Date().getTime()}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          
          // Clean up
          document.body.removeChild(exportContainer);
          hideLoading();
        });
      });
      
      exportPdf.addEventListener('click', () => {
        alert("L'export PDF n√©cessite l'ajout de la biblioth√®que jsPDF. Fonctionnalit√© √† impl√©menter.");
      });

    }
  })();
  </script>
  
  <!-- html2canvas for export functionality -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>